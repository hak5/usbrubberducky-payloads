REM ########################################################
REM #                                                      |
REM # Title        : Defend Yourself From CVE-2023-23397   |
REM # Author       : Aleff                                 |
REM # Version      : 1.0                                   |
REM # Category     : Incident-Response                     |
REM # Target       : Windows 10/11                         |
REM #                                                      |
REM ########################################################

REM PlugAndPlay <3

REM Requirements:
REM     - ExecutionPolicy Bypass
REM     - PayloadStudio 1.3.1

REM Impacted Products:
REM     - All supported versions of Microsoft Outlook for Windows are affected. Other versions of Microsoft Outlook such as Android, iOS, Mac, as well as Outlook on the web and other M365 services are not affected.

REM Mitigation:
REM     - Block TCP 445/SMB outbound from your network by using a perimeter firewall, a local firewall, and via your VPN settings. This will prevent the sending of NTLM authentication messages to remote file shares.
REM       Source: https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-23397

EXTENSION PASSIVE_WINDOWS_DETECT
    REM VERSION 1.1
    REM AUTHOR: Korben

    REM_BLOCK DOCUMENTATION
        Windows fully passive OS Detection and passive Detect Ready
        Includes its own passive detect ready.
        Does not require additional extensions.

        USAGE:
            Extension runs inline (here)
            Place at beginning of payload (besides ATTACKMODE) to act as dynamic
            boot delay
            $_OS will be set to WINDOWS or NOT_WINDOWS
            See end of payload for usage within payload
    END_REM

    REM CONFIGURATION:
    DEFINE #MAX_WAIT 150
    DEFINE #CHECK_INTERVAL 20
    DEFINE #WINDOWS_HOST_REQUEST_COUNT 2
    DEFINE #NOT_WINDOWS 7

    $_OS = #NOT_WINDOWS

    VAR $MAX_TRIES = #MAX_WAIT
    WHILE(($_RECEIVED_HOST_LOCK_LED_REPLY == FALSE) && ($MAX_TRIES > 0))
        DELAY #CHECK_INTERVAL
        $MAX_TRIES = ($MAX_TRIES - 1)
    END_WHILE
    IF ($_HOST_CONFIGURATION_REQUEST_COUNT > #WINDOWS_HOST_REQUEST_COUNT) THEN
        $_OS = WINDOWS
    END_IF

    REM_BLOCK EXAMPLE USAGE AFTER EXTENSION
        IF ($_OS == WINDOWS) THEN
            STRING HELLO WINDOWS!
        ELSE
            STRING HELLO WORLD!
        END_IF
    END_REM
END_EXTENSION

GUI x
DELAY 500
STRING a
DELAY 500
LEFTARROW
DELAY 500
ENTER

REM Import NetSecurity module
STRINGLN Import-Module NetSecurity

REM Create a new firewall rule for blocking outgoing connections on port 445
STRINGLN
    $rule = New-NetFirewallRule -DisplayName "CVE-2023-23397" `
        -Direction Outbound `
        -Action Block `
        -Protocol TCP `
        -RemotePort 445
END_STRINGLN

REM Enable firewall rule
STRINGLN Enable-NetFirewallRule -Name $rule.Name
DELAY 500

REM See your new rule
STRINGLN Get-NetFirewallRule | Where-Object { $_.DisplayName -eq "CVE-2023-23397" }
