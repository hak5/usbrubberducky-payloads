REM_BLOCK
#######################################################################################################################
#                                                                                                                     #
# Title        : Defend yourself against CVE-2023-36884 Office and Windows HTML Remote Code Execution Vulnerability   #
# Author       : Aleff                                                                                                #
# Version      : 1.0                                                                                                  #
# Category     : Incident Response                                                                                    #
# Target       : Windows 10/11                                                                                        #
#                                                                                                                     #
#######################################################################################################################

PlugAndPlay <3

Requirements:
    - ExecutionPolicy Bypass

Impact: Remote Code Execution
Max Severity: Important

Mitigation:

    - Customers who use Microsoft Defender for Office are protected from attachments that attempt to exploit this vulnerability.

    - The registry key FEATURE_BLOCK_CROSS_PROTOCOL_FILE_NAVIGATION is located in the Main folder under the Internet Explorer settings, within the path HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Internet Explorer\FeatureControl. This registry key is used to mitigate the vulnerability known as "Office and Windows HTML Remote Code Execution Vulnerability" (CVE-2023-36884).

The CVE-2023-36884 vulnerability allows remote code execution through the processing of HTML files by Office and Windows applications. Creating this registry key and adding specific application values, such as REG_DWORD with data 1, helps block cross-protocol file navigation to mitigate the exploitation of this vulnerability.

It is recommended to implement these protective measures to prevent potential attacks that could exploit the vulnerability and compromise the security of Office and Windows systems. It is important to understand the implications of modifying the registry and carefully evaluate the impact on the regular functionality of the involved applications.

Source: https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-36884
END_REM


EXTENSION PASSIVE_WINDOWS_DETECT
    REM VERSION 1.1
    REM AUTHOR: Korben

    REM_BLOCK DOCUMENTATION
        Windows fully passive OS Detection and passive Detect Ready
        Includes its own passive detect ready.
        Does not require additional extensions.

        USAGE:
            Extension runs inline (here)
            Place at beginning of payload (besides ATTACKMODE) to act as dynamic
            boot delay
            $_OS will be set to WINDOWS or NOT_WINDOWS
            See end of payload for usage within payload
    END_REM

    REM CONFIGURATION:
    DEFINE #MAX_WAIT 150
    DEFINE #CHECK_INTERVAL 20
    DEFINE #WINDOWS_HOST_REQUEST_COUNT 2
    DEFINE #NOT_WINDOWS 7

    $_OS = #NOT_WINDOWS

    VAR $MAX_TRIES = #MAX_WAIT
    WHILE(($_RECEIVED_HOST_LOCK_LED_REPLY == FALSE) && ($MAX_TRIES > 0))
        DELAY #CHECK_INTERVAL
        $MAX_TRIES = ($MAX_TRIES - 1)
    END_WHILE
    IF ($_HOST_CONFIGURATION_REQUEST_COUNT > #WINDOWS_HOST_REQUEST_COUNT) THEN
        $_OS = WINDOWS
    END_IF

    REM_BLOCK EXAMPLE USAGE AFTER EXTENSION
        IF ($_OS == WINDOWS) THEN
            STRING HELLO WINDOWS!
        ELSE
            STRING HELLO WORLD!
        END_IF
    END_REM
END_EXTENSION

GUI x
DELAY 500
STRING a
DELAY 500
LEFTARROW
DELAY 500
ENTER

REM Sets the path to the registry key
STRINGLN $registryPath = "HKLM:\SOFTWARE\Policies\Microsoft\Internet Explorer\Main\FeatureControl\FEATURE_BLOCK_CROSS_PROTOCOL_FILE_NAVIGATION"

REM Array of application names
STRINGLN 
    $applicationNames = @(
        "Excel.exe",
        "Graph.exe",
        "MSAccess.exe",
        "MSPub.exe",
        "Powerpnt.exe",
        "Visio.exe",
        "WinProj.exe",
        "WinWord.exe",
        "Wordpad.exe"
    )
END_STRINGLN

REM Create the registry key if it does not already exist
STRINGLN 
    if (!(Test-Path $registryPath)) {
        New-Item -Path $registryPath -Force | Out-Null
        echo "Registry key created"
    }
END_STRINGLN

REM Add the values to the registry key
STRINGLN
    foreach ($appName in $applicationNames) {
        Set-ItemProperty -Path $registryPath -Name $appName -Value 1 -Type DWORD -Force | Out-Null
        echo "[+] $appName"
    }
END_STRINGLN
